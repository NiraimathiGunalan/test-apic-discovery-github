name: Discover API with Javascript

on: [pull_request, workflow_dispatch, push]

env:
  API_HOST: d-h01.apiconnect.dev.automation.ibm.com
  PROVIDER_ORG: ruairi_h01_b
  API_FILE: gmail-api.json

jobs:
  check_apifiles_job:
    runs-on: 'ubuntu-20.04'
    # Declare outputs for next jobs
    outputs:
      apifiles_changed: ${{ steps.check_apifile_changed.outputs.apifile_updates }}
    steps:
    - uses: actions/checkout@v3
    - name: Check API File changed
      id: check_apifile_changed
      run: |
        #echo "::set-output name=apifile_updates::$(git diff --name-only --diff-filter=ACMRT ${{ github.sha }} | grep $API_FILE | xargs)"
        echo This $API_FILE
        echo That {{ $env.API_FILE }}
        echo Found file is $(git diff --name-only --diff-filter=ACMRT ${{ github.sha }} | grep $API_FILE | xargs)
        echo All files chnaged are $(git diff --name-only --diff-filter=ACMRT ${{ github.sha }} | xargs)
        echo "apifile_updates=$(git diff --name-only --diff-filter=ACMRT ${{ github.sha }} | grep $API_FILE | xargs)" >> $GITHUB_OUTPUT
  run-discovery:
    runs-on: ubuntu-latest
    needs: [ check_apifiles_job ]
    if: ${{needs.check_apifiles_job.outputs.apifiles_changed}}
    steps:
    - uses: actions/checkout@v3
    - uses: ruairi-hayes/apic-discovery-action@main
      id: discover-apis
      with:
        milliseconds: 5000
        api_host: $API_HOST
        provider_org: $PROVIDER_ORG
        api_key: ${{ secrets.apicApikey }}
        api_file: $API_FILE
    - name: Display the action-result
      run: |
        echo "Result of the action: ${{ steps.discover-apis.outputs.action-result }}"